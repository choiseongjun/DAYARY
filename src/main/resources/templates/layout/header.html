<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"    
		xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
    <head>
        <meta charset="UTF-8">
        <title>Fruit</title>
        <css th:fragment="headerCss"> 
             <link rel="stylesheet" href="/fonts/icomoon/style.css">
            <link rel="stylesheet" href="/css/bootstrap.min.css">
            <link rel="stylesheet" href="/css/magnific-popup.css">
            <link rel="stylesheet" href="/css/jquery-ui.css">
            <link rel="stylesheet" href="/css/owl.carousel.min.css">
            <link rel="stylesheet" href="/css/owl.theme.default.min.css">
            <link rel="stylesheet" href="/css/bootstrap-datepicker.css">
            <link rel="stylesheet" href="/fonts/flaticon/font/flaticon.css">
            <link rel="stylesheet" href="/css/aos.css">
            <link rel="stylesheet" href="/css/style.css"> 
            <!-- <link rel="stylesheet" href="/css/headernav.css"> -->
            <!-- 여기서부터 퍼블리싱한내용들 -->
            <link rel="stylesheet" href="/publ/css/common.css">
			<link rel="stylesheet" href="/publ/css/fruit.css">
			<link rel="stylesheet" href="/publ/css/jquery.selectlist.css">
			<link rel="stylesheet" href="/publ/css/layout.css">
			<link rel="stylesheet" href="/publ/css/owl.carousel.min.css">
			<link rel="stylesheet" href="/publ/css/owl.theme.default.min.css">
        </css> 
        <!-- <css th:fragment="moimDetailsubmenu"> -->  
          <!-- <link rel="stylesheet" href="/css/moim/moimDetailsubmenu.css"> -->
          
        
            </head>
    <body>
        <div th:fragment="header">
        
            <div class="site-mobile-menu">
                <div class="site-mobile-menu-header">
                    <div class="site-mobile-menu-close mt-3">
                        <span class="icon-close2 js-menu-toggle"></span>
                    </div>
                </div>
                <div class="site-mobile-menu-body"></div>
            </div>

            <!-- <header class="site-navbar" role="banner">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-12 search-form-wrap js-search-form">
                            <form method="get" action="#">
                                <input type="text" id="s" class="form-control"
                                       placeholder="Search...">
                                <button class="search-btn" type="submit">
                                    <span class="icon-search"></span>
                                </button>
                            </form>
                        </div>
                        <div class="col-4 site-logo">
                            <a href="/" class="text-black h2 mb-0"><img src="/publ/images/layout/logo.png" width="100px" height="80px"/></a>
                        </div>
                        <div class="col-8 text-right">
                            <nav class="site-navigation" role="navigation">
                            	<div id="socketAlert" class="alert alert-success" role="alert" style="display:none;"></div>임시 알림창
                                <ul class="site-menu js-clone-nav mr-auto d-none d-lg-block mb-0">
                                    <li>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                        <a href="/">Home</a>
                                    </li>
                                    <li>
                                        <a href="/moimlistView/11">크루 찾기</a>
                                    </li>
                                    <li>
                                        <a href="/community/timeLine">커뮤니티</a>
                                    </li>
                                   	<li sec:authorize="hasAuthority('ROLE_USER')">
                                        <a href="/moimMakeView">크루 만들기</a>
                                    </li>
                                    <li sec:authorize="isAnonymous()">
                                        <a href="/signupView">회원가입</a>
                                    </li>
                                  	<li sec:authorize="isAnonymous()">
                                        <a href="/signinView">로그인
                                        </a>
                                    </li>
                                        <a href="/logout">로그아웃</a>
                                    </li>
                                 
                                    <li sec:authorize="hasAuthority('ROLE_USER')">
                                        <a href="/myprofileView">내정보보기 
                                      </a>
                                    </li>
                             
                                    <li sec:authorize="hasAuthority('ROLE_USER')">
                                        <div class="notification notishow">
                                            <span>Inbox</span>
                                            <span class="badge">3</span>
                                        </div>
                                    </li>
                                    <li class="d-none d-lg-inline-block">
                                        <a href="#" class="js-search-toggle">
                                            <span class="icon-search"></span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                            <a href="#" class="site-menu-toggle js-menu-toggle text-black d-inline-block d-lg-none">
                                <span class="icon-menu h3"></span>
                            </a>
                        </div>
                    </div>
                </div>
            </header> -->
			<header id="header">
				<div class="inner">
					<h1 class="logo"><a href="/"><img src="/publ/images/layout/logo.png" alt="Fruit 로고"></a></h1>
					<div class="gnb_box">
						<nav id="nav">
						
							<ul class="gnb" id="menu_list_user">
									<li class="gnbA gnbA1" id="menu1"></li>
									<th:block th:if="${test}==on">
										<li class="gnbA gnbA2 on" id="menu2"></li>
									</th:block>
									<th:block th:unless="${test}==on">
										<li class="gnbA gnbA2" id="menu2"></li>
									</th:block>
									<th:block th:if="${menu3_hover}==on">
									<li class="gnbA gnbA3 on" id="menu3"></li>
									</th:block>
									<th:block th:unless="${menu3_hover}==on">
									<li class="gnbA gnbA3" id="menu3"></li>
									</th:block>
									<li class="gnbA gnbA4" id="menu4" sec:authorize="isAnonymous()"></li>
									<th:block th:if="${menu5_hover}==on">
									<li class="gnbA gnbA4 on" id="menu5" sec:authorize="isAnonymous()"></li>
									</th:block>
									<th:block th:unless="${menu5_hover}==on">
									<li class="gnbA gnbA4" id="menu5" sec:authorize="isAnonymous()"></li>
									</th:block>
									<li class="gnbA gnbA4" id="menu6" sec:authorize="hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')"></li>
									<li class="gnbA gnbA4" id="menu7" sec:authorize="hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')"></li>
							</ul> 
							<ul class="gnb" id="menu_list_anony" sec:authorize="isAnonymous()">
							</ul>
						</nav>
					</div>
					<div class="total_search_box">
					<a href="#none" class="search_btn"><span class="icon">통합검색<span class="text_hidden">열기</span></span></a>
	                <th block sec:authorize="hasAuthority('ROLE_USER')">
	                <a href="#none" class="my_btn" ><span class="icon">마이페이지<span class="text_hidden">열기</span></span></a>
	                <a href="#none" class="alarm_btn"><span class="alarm_num"></span><span class="icon">알람<span class="text_hidden">열기</span></span>
	                <ul class="my_page_box">
	                	<li><a href="/myprofileView">마이페이지</a></li>
	                    <li><a href="#">로그아웃</a></li>
	                </ul>
	                </th>
				</div>
				</div>
			</header>
			<div class="blank"></div>
			    <div class="search_box">
			    	<div class="inner_popup">
			        	<div>
			        		<input placeholder="sample"><button>Search</button>
			            </div>
			            <ul class="search_chart_ul">
			            	<li>추천</li>
			                <li><a href="">#Hashtag_1</a></li>
			                <li><a href="">#Hashtag_1</a></li>
			                <li><a href="">#Hashtag_1</a></li>
			                <li><a href="">#Hashtag_1</a></li>
			                <li><a href="">#Hashtag_1</a></li>
			                <li><a href="">#Hashtag_1</a></li>
			                <li><a href="">#Hashtag_1</a></li>
			            </ul>
			        </div>
			    </div>
			    
			    <div class="alarm_list_box">
			    	<div class="inner_popup">
			        	
			        	<p class="alarm_title">alarm_title<span>: Alarm Description...</span><a href="#" class="more_alarm_list">더보기</a></p>
			            <div class="alarm_list_table_box">
			                <table width="100%" class="alarm_list_table">
			                    <colgroup>
			                        <col width="80px">
			                        <col width="auto">
			                        <col width="90px">
			                    </colgroup>
			                    <tbody id="notiList" data="">
			                    </tbody>
			                </table>
			            </div>
			        </div>
			    </div>
          	<script src="/publ/js/jquery/jquery-3.4.1.min.js"></script>
		    <script src="/js/jquery-migrate-3.0.1.min.js"></script>
            <script src="/js/jquery-ui.js"></script>
            <script src="/js/popper.min.js"></script>
            <script src="/js/bootstrap.min.js"></script>
            <script src="/js/owl.carousel.min.js"></script>
            <script src="/js/jquery.stellar.min.js"></script>
            <script src="/js/jquery.countdown.min.js"></script>
            <script src="/js/jquery.magnific-popup.min.js"></script>
            <script src="/js/bootstrap-datepicker.min.js"></script>
            <script src="/js/aos.js"></script>
            <script src="/js/main.js"></script>
            <script src="/publ/js/owl.carousel.min.js"></script>
		    <!--  <script src="/publ/js/jquery/jquery-migrate-1.4.1.min.js"></script>  -->
		     <script src="/publ/js/jquery/jquery-ui-1.12.1.min.js"></script>
		     <script src="/publ/js/jquery/jquery.bxslider.js"></script>
		     <script src="/publ/js/jquery/jquery.easing.1.2.js"></script>
		     <script src="/publ/js/jquery/jquery.nicescroll.min.js"></script>
		     <script src="/publ/js/jquery/jquery.selectric.js"></script>
		     <script src="/publ/js/fruit.js"></script> 
		     <script src="/publ/js/jquery.selectlist.js"></script> 
          <!--  <script src="/js/jquery-3.3.1.min.js" ></script> --> 
         <!--     <script src="/js/jquery-migrate-3.0.1.min.js"></script>
            <script src="/js/jquery-ui.js"></script>
            <script src="/js/popper.min.js"></script>
            <script src="/js/bootstrap.min.js"></script>
            <script src="/js/owl.carousel.min.js"></script>
            <script src="/js/jquery.stellar.min.js"></script>
            <script src="/js/jquery.countdown.min.js"></script>
            <script src="/js/jquery.magnific-popup.min.js"></script>
            <script src="/js/bootstrap-datepicker.min.js"></script>
            <script src="/js/aos.js"></script>  -->
            <!-- <script src="/js/main.js"></script>  -->
            <!-- 퍼블리셔부분 -->
            <!-- 알림창스크립트임시로 박아놓음 나중에 js폴더로 관리할것 by choiseongjun -->
            <script>
                $(document).ready(function () {
                	
                	$.ajax({
              	      url:'/Menulist',
              	        type:'get',
              	        processData: false, //데이터를 쿼리 문자열로 변환하는 jQuery 형식 방지
              	        contentType: false,
              	        dataType:'json',
              	        cache: false,
              	        //data: formData,
              	        success:function(data) {
              	        	var m=data;
                    		var html=""
                    		var menu1="";
            	        	var menu2="";
            	        	var menu3="";
            	        	var menu4="";
            	        	var menu5="";
            	        	var menu6="";
            	        	var menu7="";
            	        	for(var i=0;i<m.length;i++){
            	        		if(m[i].id==1){
            	        			menu1+="<a href='"+data[i].menu_url+"'>"+data[i].menu_name+"</a>";
            	        		}
            	        		if(m[i].id==2){
            	        			menu2+="<a href='"+data[i].menu_url+"'>"+data[i].menu_name+"</a>";
            	        		}
            	        		if(m[i].id==3){
            	        			menu3+="<a href='"+data[i].menu_url+"'>"+data[i].menu_name+"</a>";
            	        		}
            	        		if(m[i].id==4){
            	        			menu4+="<a href='"+data[i].menu_url+"'>"+data[i].menu_name+"</a>";
            	        		}
            	        		if(m[i].id==5){
            	        			menu5+="<a href='"+data[i].menu_url+"'>"+data[i].menu_name+"</a>";
            	        		}
            	        		if(m[i].id==6){
            	        			menu6+="<a href='"+data[i].menu_url+"'>"+data[i].menu_name+"</a>";
            	        		}
            	        		if(m[i].id==7){
            	        			menu7+="<a href='"+data[i].menu_url+"'>"+data[i].menu_name+"</a>";
            	        		}
            	        	}
            	        	$("#menu1").html(menu1);
            	        	$("#menu2").html(menu2);
            	        	$("#menu3").html(menu3);
            	        	$("#menu4").html(menu4);
            	        	$("#menu5").html(menu5);
            	        	$("#menu6").html(menu6);
            	        	$("#menu7").html(menu7);
              	       }
              	   });
                	
                	
                	connectStomp();
                	if($("#menu7").val()!=undefined){
                		getMyNotiListCount();
                		connectStompforPrivate();
                	}
                });
                function getMyNotiListCount(){
                	$.ajax({
					      url:'/getMyNotiListCount',
					        contentType: "application/json; charset=utf-8",
					        processData: false, //데이터를 쿼리 문자열로 변환하는 jQuery 형식 방지
					        success:function(data){
						        if(data.code==1){
						        	$(".alarm_num").append(data.count);
						        	
						        }
					        	
					        }, error:function(e){
								alert(e)
					        }
					    });     
                }
                    $(".alarm_btn").click(function (e) {
						e.stopPropagation();
						e.preventDefault();
						getNotiList(1);
						//읽으면 알림 0
						document.getElementsByClassName("alarm_num")[0].innerHTML=0;
                    });
                    $(".more_alarm_list").click(function (e) {
                    	var notiList =document.getElementById("notiList");
                    	var pageNum=parseInt(notiList.childElementCount/9)+1;
                    	getNotiList(pageNum);
                    });
                
            	function getNotiList(pageNum){
					if($("#notiList").attr("data")==pageNum){
						$(".more_alarm_list").toggle();
						return;
					}
					$.ajax({
					      url:'/getMyNotiList/'+pageNum,
					        contentType: "application/json; charset=utf-8",
					        processData: false, //데이터를 쿼리 문자열로 변환하는 jQuery 형식 방지
					        success:function(data){
						        	var notilist=data.notiList;
						        	console.log(notilist);
						        	if(notilist.length>0){
						        		var html=""
							        		for(var i in notilist){
							    				html += '<tr>'
							    				html += 	' <td class="user_pic"><img src="/publ/images/contents/sample.png"></td>'
							    				html += 	'<td>'
							    				html += 	'<a href="/moimlistView/moimdetailView/'+notilist[i].moim.id+'">'+notilist[i].memo+'</a>'
												html += 	'</td>'
												html += 	'<td>'+notilist[i].createDate.slice(0,10)+'</td>'
								   				html += '</tr>'
							        		}
						        		$("#notiList").append(html);
						        		$("#notiList").attr("data",pageNum);
						        	}
						        
						        	
					        	
					        }, error:function(e){
								alert(e)
					        }
					    });     
            	}
	         
	           	var socket=null;
	           	var isStomp=false;
	           	function connectStomp() {
	           		var sock = new SockJS("/noti"); // endpoint
	           	    var client = Stomp.over(sock);
	           		isStomp = true;
	           		socket = client;

	           	}
	           	function connectStompforPrivate()	{
	           	 
	           	    socket.connect({}, function () {
	           	        console.log("Connected PrivateNoti!");
	           	       socket.subscribe('/topic/noti', onMessageReceivedPrivate);
	           	        
	           	    });
	           	}
	           	    function onMessageReceivedPrivate(payload) {
	           	    console.log(message);
	           		var message = JSON.parse(payload.body);
	           		var message = JSON.parse(payload.body);
	           		if(message.gubunCd=='M'){
						if(location.href.indexOf("moimdetail")>0)
	           			$("#noti").prepend('<span>'+message.memo+'</span><span>'+message.createDate+'</span><br>');
	           			
	           		}
	           		else if(message.gubunCd=='P'){
	           			var html="";
	           	   		document.getElementsByClassName("alarm_num")[0].innerHTML++;
	           			html += '<tr>'
	           				html += 	' <td class="user_pic"><img src="/publ/images/contents/sample.png"></td>'
	           				html += 	'<td>'
	           				html += 	'<a href="moimlistView/moimdetailView/'+message.moim.id+'">'+message.memo+'</a>'
	           				html += 	'</td>'
	           				html += 	'<td>'+message.slice(0,10)+'</td>'
	           					html += '</tr>'
	           		$("#notiList").prepend(html);
	           		}else{
	           			if($('#peopleId').attr("data-peopleId")==message.peopleId){
	           				$('.chat-box').append('<li class="chat-right"><div class="chat-hour"><div class="chat-hour">'+message.createDate+'</div></div><div class="chat-text">'+message.msg+'</div><div class="chat-avatar"><img src="'+message.imageName+'.'+message.imageExtension+'"> <div class="chat-name">'+message.peopleEmail+'</div></div></li>');
	           			}else{
	           				$('.chat-box').append('<li class="chat-left"><div class="chat-avatar"><img src="'+message.imageName+'.'+message.imageExtension+'"><div class="chat-name">'+message.peopleEmail+'</div></div><div class="chat-text" id="chatList">'+message.msg+'</div><div class="chat-hour">'+message.createDate+'</div></div></li>');
	           			}
	           			 
	           			downFocus();
	           		}
	           	}
            </script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        </div>
    </body>
</html>